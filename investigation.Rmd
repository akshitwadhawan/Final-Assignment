---
title: "IDS investigation worksheet"
author: "by Workshop 10: Euan McKerron, Yujun Ling, Akshit Wadhawan & Ariane Baillie"
date: "`r Sys.Date()`"
output: html_document
---

**Note:** You can use this file as you 'working document' where you can try out various investigation ideas and keep notes about your findings. How you use and structure this file is up to you. It is recommended that you keep notes about what you are investigating and what you find as this will make the process of creating your presentation and report easier. Please note that you _do not_ need to submit this file as part of your group project.



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load-lib, message = FALSE}
library(tidyverse)
library(readxl)
library(janitor)
library(ggplot2)
library(lubridate)
library(zoo)
library(scales)
library(dplyr)
library(tidymodels)
library(yardstick)
# Add any other libraries here


```


```{r load-data}
# load your data 
data <- read_excel("data/criminal age dataset.xlsx")

#renaming column heading and cleaning the data so that mini headings are not in the age column
names(data)[1] <- "age"

clean_data <- data %>%
  filter(
    !age %in% c("Males and Females", "Remand", "Sentenced", "Non criminal prisoners")
  )

#removing the percentage change column

clean_data <- clean_data %>%
  select(-`Percentage change \r\nJune 2022 to 2023`)


#having to change the format of the data set to long form

data_long <- clean_data %>%
  pivot_longer(
    cols = -age,
    names_to = "date",
    values_to = "values"
  )

#forcing the value to be numeric 

data_long$values <- as.numeric(gsub(",", "", data_long$values))

#bar plot to compare age against total number of criminals

ggplot(data_long, aes(
    x = age,
    y = values / 1000,
    fill = date
    )) +
  geom_bar(stat="identity") +
  labs(
    x = "age categories",
    y = "number of prisoners in thousands",
    title = "Number of prisoners by age",
    subtitle = "data between 2022 and 2023",
    fill = "date")

```


```{r}
data <- read_excel("data/Copy of Punishments.xlsx")

#having to set the data into the different age categories

data <- data %>%
  mutate(
    `Age group` = factor(`Age group`, 
                         levels = c("15 - 17", "18 - 20", "21 - 24", "25 - 29",
                                    "30 - 39", "40 - 49", "50 - 59", "60 - 69", "70 and over")),
    `Predominant function of establishment` = factor(`Predominant function of establishment`)
  )

#making the graph having to make it into count plot so the frequency can be determined

ggplot(data,
       aes(
    x = `Age group`,
    y = `Predominant function of establishment`
)) +
    geom_count(color="Green", alpha = 0.7) +
    scale_size_area(max_size = 20) +
    labs(
        title = "Frequency of Establishment Function by Age Group",
        x = "Age group",
        y = "Predominant function of establishment",
        size = "Count"
    ) +
    theme_minimal()+ 
  theme( axis.text.x = element_text(angle = 45, hjust = 1) 
         )

#using these functions since labels are longer so readability becomes better
```



```{r}
df <- read_excel("data/criminal age dataset.xlsx")

#make column name easier to type
names(df) <- tolower(names(df))
names(df) <- gsub(" ", "_", names(df))

main_col <- names(df)[1]

#change name for percentage and put them in numeric terms
pct_col <- grep("percentage", names(df), value = TRUE)
if(length(pct_col) > 0) {
  names(df)[names(df) == pct_col] <- "pct_change"
}

if("pct_change" %in% names(df)) {
  df$pct_change <- suppressWarnings(as.numeric(df$pct_change))
}

#identify category header rows
df$category <- NA

for(i in seq_len(nrow(df))) {
  val <- df[[main_col]][i]
  if(!grepl("[0-9]", val)) {
    df$category[i] <- val
  }
}

df$category <- na.locf(df$category) #fill the category downward

df_clean <- df[grepl("[0-9]", df[[main_col]]), ] 

# Rename
names(df_clean)[names(df_clean) == main_col] <- "age_band"

# Identify count columns
num_cols <- names(df_clean)[sapply(df_clean, is.numeric)]
num_cols <- setdiff(num_cols, "pct_change")

# Reshape format
df_long <- df_clean %>%
  pivot_longer(
    cols = all_of(num_cols),
    names_to = "date",
    values_to = "count"
  )

# Clean date column
df_long$date <- gsub("^x", "", df_long$date)
df_long$date <- dmy(df_long$date)

ggplot(df_long, aes(x = date, y = count, color = age_band)) +
  geom_line() +
  facet_wrap(~ category, scales = "free_y") +
  labs(
    title = "Prison Population Over Time",
    x = "Date",
    y = "Number of Prisoners",
    color = "Age Band"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom"
    )
view(df)
```

```{r}
data <- read_excel("data/Age vs Sentence 1.0.xlsx")
names(data)[1] <- "Category"

data <- data %>%
  mutate(across(-Category, as.numeric),
         Total = rowSums(across(-Category), na.rm = TRUE))

age_groups <- c("Adults", "18-20 year olds", "15-17 year olds")

data_summary <- data %>%
  mutate(Age = if_else(Category %in% age_groups, Category, NA_character_)) %>%
  fill(Age) %>%
  filter(Category %in% c(
    "Less than or equal to 6 months",
    "Greater than 6 months to less than 12 months",
    "12 months to less than 4 years",
    "4 years or more (excluding indeterminate sentences)"
  )) %>%
  group_by(Age, Category) %>%
  summarise(Total = sum(Total, na.rm = TRUE)) %>%
  mutate(Proportion = Total / sum(Total))

ggplot(data_summary, aes(x = Age, y = Proportion, fill = Category)) +
  geom_col(position = "fill") +
  scale_y_continuous(labels = percent, breaks = seq(0, 1, 0.1)) +
  labs(
    title = "Proportion of Sentence Lengths by Age Group",
    subtitle = "From 2002-2023",
    x = "Age Group",
    y = "Proportion", 
    fill = "Sentence Length"
  ) +
  theme_minimal()

```

```{r}
##load data
data2 <- read_excel("data/criminal age and offense type dataset.xlsx")

## Clean data, add what age group each observation is, rename columns
data2 <- data2 %>%
  select(1:6) %>%
  mutate(
    age_group = case_when(
      row_number() %in% 1:14 ~ "Adult",
      row_number() %in% 15:28 ~ "18-20",
      TRUE ~ "15-17"
    ))

## Remove extra variables, remove rows that are not needed, pivot wider and 
## add a count variable
bar_graph_data <- data2 %>%
  select(c(1,6,7)) %>%
  filter(
    ...1 != "Adults",
    ...1 != "18-20 year olds",
    ...1 != "15-17 year olds"
  ) %>%
  pivot_wider(
    names_from = '...1' ,
    values_from = '30-Jun-2023' 
  )
bar_graph_data <- bar_graph_data %>%
  pivot_longer(
    cols = !c(age_group),
    names_to = "type_of_offense",
    values_to = "count"
  )



##graph
bar_graph_data %>%
  ggplot(aes(
    x = age_group, 
    y = count, 
    fill = type_of_offense)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  facet_wrap(
    ~ age_group, 
    scales = "free",
    labeller = labeller(
      age_group = c(
        '15-17' = '15-17 year olds',
        '18-20' = '18-20 year old',
        'Adult' = 'Adults'
      )
    )) +
  labs(
    title = 'Number of each type of offense by age group' ,
    subtitle = 'Data from June 2023' ,
    x = 'Age group' ,
    y = 'Number of offenses' ,
    fill = 'Type of offense'
  )
```

```{r}
#load data
data <- read_excel("data/Copy of Punishments.xlsx")

#mutate data frame to have an offense type variable and change variables to factors
data <- data %>% janitor::clean_names()

data_offense_type <- data %>%
  mutate(offence_type = ifelse(
    offence == "Violence", "Violent", "Non-Violent"
    )
  )

data_offense_type$age_group <- as.factor(data_offense_type$age_group)
data_offense_type$offence_type <- as.factor(data_offense_type$offence_type)
data_offense_type$sex <- as.factor(data_offense_type$sex)

#split the data into a testing and training set
set.seed(32)
data_split <- initial_split(data_offense_type)
data_train <- training(data_split)
data_test <- testing(data_split)

#workflow
data_mod <- logistic_reg() %>% 
  set_engine("glm")

data_rec <- recipe(offence_type ~ age_group + sex, data = data_train)

data_wflow <- workflow() %>%
  add_recipe(data_rec) %>%
  add_model(data_mod)

data_fit <- fit(data_wflow, data_train)

tidy(data_fit)

#Model evaluation of model containing all categorical predictors
pred_test <- predict(
  data_fit, data_test, type = "prob"
) %>%
  bind_cols(data_test %>% select(offence_type))

pred_test %>%
  roc_curve(
    truth = offence_type,
    `.pred_Non-Violent`,
    event_level = "first"
  ) %>%
  autoplot()

roc_auc(pred_test, truth = offence_type, `.pred_Non-Violent`)
```

```{r}
#load data
data <- read_excel("data/Copy of Punishments.xlsx")
data <- data %>% janitor::clean_names()

#organise and mutate dataset to use for project
data_type <- data %>%
  mutate(offence_type = ifelse(
    offence == "Violence", "Violent", "Non-Violent"
  )) %>%
  select(predominant_function_of_establishment, age_group, offence_type, sex)

data_type$age_group <- as.factor(data_type$age_group)
data_type$offence_type <- as.factor(data_type$offence_type)
data_type$predominant_function_of_establishment <- as.factor(data_type$predominant_function_of_establishment)
data_type$sex <- as.factor(data_type$sex)

colnames(data_type) <- c("est_type", "age_group", "offence_type", "sex")

#bar plots to see if there are any trends in the data
##bar plot of number of offences versus sex (with offence_type stacked)
data_type_sex <- data_type %>%
  select(offence_type, sex) %>%
  mutate(
    count = n(),
    count = case_when(
      count == 37552 ~ 1
    ),
    count = as.numeric(count)
  )

data_type_sex_tibble <- data_type_sex %>%
  pivot_wider(
    names_from = sex,
    values_from = count,
    values_fn = sum
  )
as_tibble(data_type_sex_tibble)

data_type_sex %>%
  ggplot(aes(
    x = sex, 
    y = count, 
    fill = offence_type)) +
    geom_bar(stat = "identity") +
    theme_minimal() +
    facet_wrap(
      ~ sex, 
      scales = "free",
    )

##bar plot of number of offences versus establishment type (with offence_type stacked)
data_type_est <- data_type %>%
  select(offence_type, est_type) %>%
  mutate(
    count = n(),
    count = case_when(
      count == 37552 ~ 1
    ),
    count = as.numeric(count)
  )

data_type_est_tibble <- data_type_est %>%
  pivot_wider(
    names_from = est_type,
    values_from = count,
    values_fn = sum
  )
as_tibble(data_type_est_tibble)

data_type_est %>%
  ggplot(aes(
    x = est_type, 
    y = count, 
    fill = offence_type)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  facet_wrap(
    ~ est_type, 
    scales = "free",
  )

##bar plot of number of offences versus age group (with offence_type stacked)
data_type_age <- data_type %>%
  select(offence_type, age_group) %>%
  mutate(
    count = n(),
    count = case_when(
      count == 37552 ~ 1
    ),
    count = as.numeric(count)
  )

data_type_age_tibble <- data_type_age %>%
  pivot_wider(
    names_from = age_group,
    values_from = count,
    values_fn = sum
  )
as_tibble(data_type_age_tibble)

data_type_age %>%
  ggplot(aes(
    x = age_group, 
    y = count, 
    fill = offence_type)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  facet_wrap(
    ~ age_group, 
    scales = "free",
  )
```

