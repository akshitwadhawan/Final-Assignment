---
title: "IDS investigation worksheet"
author: "by Workshop 10: Euan McKerron, Yujun Ling, Akshit Wadhawan & Ariane Baillie"
date: "`r Sys.Date()`"
output: html_document
---

**Note:** You can use this file as you 'working document' where you can try out various investigation ideas and keep notes about your findings. How you use and structure this file is up to you. It is recommended that you keep notes about what you are investigating and what you find as this will make the process of creating your presentation and report easier. Please note that you _do not_ need to submit this file as part of your group project.



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load-lib, message = FALSE}
library(tidyverse)
library(readxl)
library(janitor)
library(ggplot2)
library(lubridate)
library(zoo)
library(scales)
library(dplyr)
# Add any other libraries here


```


```{r load-data}
# load your data 
data <- read_excel("data/criminal age dataset.xlsx")

#renaming column heading and cleaning the data so that mini headings are not in the age column
names(data)[1] <- "age"

clean_data <- data %>%
  filter(
    !age %in% c("Males and Females", "Remand", "Sentenced", "Non criminal prisoners")
  )

#removing the percentage change column

clean_data <- clean_data %>%
  select(-`Percentage change \r\nJune 2022 to 2023`)


#having to change the format of the data set to long form

data_long <- clean_data %>%
  pivot_longer(
    cols = -age,
    names_to = "date",
    values_to = "values"
  )

#forcing the value to be numeric 

data_long$values <- as.numeric(gsub(",", "", data_long$values))

#bar plot to compare age against total number of criminals

ggplot(data_long, aes(
    x = age,
    y = values / 1000,
    fill = date
    )) +
  geom_bar(stat="identity") +
  labs(
    x = "age categories",
    y = "number of prisoners in thousands",
    title = "Number of prisoners by age",
    subtitle = "data between 2022 and 2023",
    fill = "date")

```

```{r}
df <- read_excel("data/criminal age dataset.xlsx")

#make column name easier to type
names(df) <- tolower(names(df))
names(df) <- gsub(" ", "_", names(df))

main_col <- names(df)[1]

#change name for percentage and put them in numeric terms
pct_col <- grep("percentage", names(df), value = TRUE)
if(length(pct_col) > 0) {
  names(df)[names(df) == pct_col] <- "pct_change"
}

if("pct_change" %in% names(df)) {
  df$pct_change <- suppressWarnings(as.numeric(df$pct_change))
}

#identify category header rows
df$category <- NA

for(i in seq_len(nrow(df))) {
  val <- df[[main_col]][i]
  if(!grepl("[0-9]", val)) {
    df$category[i] <- val
  }
}

df$category <- na.locf(df$category) #fill the category downward

df_clean <- df[grepl("[0-9]", df[[main_col]]), ] 

# Rename
names(df_clean)[names(df_clean) == main_col] <- "age_band"

# Identify count columns
num_cols <- names(df_clean)[sapply(df_clean, is.numeric)]
num_cols <- setdiff(num_cols, "pct_change")

# Reshape format
df_long <- df_clean %>%
  pivot_longer(
    cols = all_of(num_cols),
    names_to = "date",
    values_to = "count"
  )

# Clean date column
df_long$date <- gsub("^x", "", df_long$date)
df_long$date <- dmy(df_long$date)

ggplot(df_long, aes(x = date, y = count, color = age_band)) +
  geom_line() +
  facet_wrap(~ category, scales = "free_y") +
  labs(
    title = "Prison Population Over Time",
    x = "Date",
    y = "Number of Prisoners",
    color = "Age Band"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom"
    )
view(df)
```

```{r}
df <- read_excel("data/Age vs Sentence 1.0.xlsx")
names(df)[1] <- "Category"

df <- df %>%
  mutate(across(-Category, as.numeric),
         Total = rowSums(across(-Category), na.rm = TRUE))

age_groups <- c("Adults", "18-20 year olds", "15-17 year olds")

df_summary <- df %>%
  mutate(Age = if_else(Category %in% age_groups, Category, NA_character_)) %>%
  fill(Age) %>%
  filter(Category %in% c(
    "Less than or equal to 6 months",
    "Greater than 6 months to less than 12 months",
    "12 months to less than 4 years",
    "4 years or more (excluding indeterminate sentences)"
  )) %>%
  group_by(Age, Category) %>%
  summarise(Total = sum(Total, na.rm = TRUE)) %>%
  mutate(Proportion = Total / sum(Total))

ggplot(df_summary, aes(x = Age, y = Proportion, fill = Category)) +
  geom_col(position = "fill") +
  scale_y_continuous(labels = percent, breaks = seq(0, 1, 0.1)) +
  labs(
    title = "Proportion of Sentence Lengths by Age Group",
    subtitle = "From 2002-2023",
    x = "Age Group",
    y = "Proportion", 
    fill = "Sentence Length"
  ) +
  theme_minimal()

```

```{r}
##load data
data2 <- read_excel("data/criminal age and offense type dataset.xlsx")

## Clean data, add what age group each observation is, rename columns
data2 <- data2 %>%
  select(1:6) %>%
  mutate(
    age_group = case_when(
      row_number() %in% 1:14 ~ "Adult",
      row_number() %in% 15:28 ~ "18-20",
      TRUE ~ "15-17"
    ))

## Remove extra variables, remove rows that are not needed, pivot wider and 
## add a count variable
bar_graph_data <- data2 %>%
  select(c(1,6,7)) %>%
  filter(
    ...1 != "Adults",
    ...1 != "18-20 year olds",
    ...1 != "15-17 year olds"
  ) %>%
  pivot_wider(
    names_from = '...1' ,
    values_from = '30-Jun-2023' 
  )
bar_graph_data <- bar_graph_data %>%
  pivot_longer(
    cols = !c(age_group),
    names_to = "type_of_offense",
    values_to = "count"
  )



##graph
bar_graph_data %>%
  ggplot(aes(
    x = age_group, 
    y = count, 
    fill = type_of_offense)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  facet_wrap(
    ~ age_group, 
    scales = "free",
    labeller = labeller(
      age_group = c(
        '15-17' = '15-17 year olds',
        '18-20' = '18-20 year old',
        'Adult' = 'Adults'
      )
    )) +
  labs(
    title = 'Number of each type of offense by age group' ,
    subtitle = 'Data from June 2023' ,
    x = 'Age group' ,
    y = 'Number of offenses' ,
    fill = 'Type of offense'
  )
```

