---
title: "Investigating the Predictors of Violent Crime"
author: "Workshop 10 <br> Euan McKerron, Yujun Ling, Akshit Wadhawan & Ariane Baillie"
institute: "University of Edinburgh"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    lib_dir: libs
    nature:
      ratio: "16:9"
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      
---

```{r install-package, include = FALSE, eval = FALSE}
# Copy and paste the following code into your console to download and install
# the `xaringan` package that contains all of the code which allows you 
# to create presentation slides in Rmarkdown
```


```{r load-packages, include = FALSE}
# Add any additional packages you need to this chunk
library(tidyverse)
library(tidymodels)
library(palmerpenguins)
library(knitr)
library(xaringanthemer)
library(readxl)
library(janitor)
library(ggplot2)
library(lubridate)
library(zoo)
library(scales)
library(dplyr)
library(yardstick)
library(kableExtra)
```

```{r setup, include=FALSE}
# For better figure resolution
knitr::opts_chunk$set(fig.retina = 3, dpi = 300, fig.width = 6, fig.asp = 0.618, out.width = "80%")
```

```{r load-data, include=FALSE}
data <- read_excel("data/Copy of Punishments.xlsx")

data_names <- data %>% janitor::clean_names()

#mutate data frame to have an offense type variable and change variables to factors
data_type <- data_names %>%
  mutate(offence_type = ifelse(
    offence == "Violence", "Violent", "Non-Violent"),
    fct_recode(age_group, 'X15' = '15 - 17',  'X18' = '18 - 20',  'X21' = '21 - 24',
               'X25' = '25 - 29',  'X30' = '30 - 39',  'X40' = '40 - 49',
               'X50' = '50 - 59',  'X60' = '60 - 69',  'X70' = '70 and over')
  ) %>%
  rename(age_mod = `fct_recode(...)`) %>%
  select(predominant_function_of_establishment, age_group, offence_type, sex, age_mod)

data_type$age_group <- as.factor(data_type$age_group)
data_type$offence_type <- as.factor(data_type$offence_type)
data_type$predominant_function_of_establishment <- as.factor(data_type$predominant_function_of_establishment)
data_type$sex <- as.factor(data_type$sex)

colnames(data_type) <- c("est_type", "age_group", "offence_type", "sex", "age_mod")
```

```{r include=FALSE}

#Background image
style_xaringan(
  title_slide_background_image = "img/ministry of justice.jpg"
)
```


# Introduction

- What age range do you think commit the most crime?


--


- This project looks at how different factors like age, sex, and establishment type influence whether offenders commit violent or non-violent crimes. 

--

- By looking at the patterns in the data, we can get a sense of whether these factors might help us predict trends within prison populations.

---

# Data Overview

- This investigation draws on data from the Offender Management Statistics Quarterly: January to March 2023, published by the Ministry of Justice. The dataset offers detailed records on people entering, leaving, or serving sentences within the criminal justice system in England and Wales, giving a clear picture of how individuals move through the system.

--

- Our main variables after cleaning includes:
```{r, echo = FALSE, results = 'asis'}
Var_table <- data.frame(
  Variable = c("offence_type", "age_group", "est_type", "sex"),
  Type = c("factor", "factor", "factor", "factor"),
  Description = c("Describes whether a crime was violent or non-violent.", "The age group of the offender.", "The type of establishment the offender was located in.", "The sex of the offender.")
)

knitr::kable(Var_table)
```

--

These variables allow us to explore how age, sex, establishment type and offence type relate to violent crime. Using official government data ensures the analysis is reliable and nationally representative.
---

class: inverse, middle, center

# Initial Exploration and Data Visualisations

---

class: middle

.pull-left[
```{r bar-plots-sex, echo = FALSE}
#bar plots to see if there are any trends in the data
##bar plot of number of offences versus sex (with offence_type stacked)
data_type_sex <- data_type %>%
  select(offence_type, sex) %>%
  mutate(
    count = n(),
    count = case_when(
      count == 37552 ~ 1
    ),
    count = as.numeric(count)
  )

data_type_sex %>%
  ggplot(aes(
    x = sex, 
    y = count, 
    fill = offence_type)) +
    geom_bar(stat = "identity") +
    theme_minimal() +
    facet_wrap(
      ~ sex, 
      scales = "free",
    ) +
  labs(
    title = 'Proportion of violent to non-violent crime based on sex' ,
    x = 'Sex' ,
    y = 'Number of offenses' ,
    fill = 'Type of offense'
  )
```

```{r bar-plots-age, echo = FALSE}
data_type_est <- data_type %>%
  select(offence_type, est_type) %>%
  mutate(
    count = n(),
    count = case_when(
      count == 37552 ~ 1
    ),
    count = as.numeric(count)
  )

data_type_est %>%
  ggplot(aes(
    x = est_type, 
    y = count, 
    fill = offence_type)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  facet_wrap(
    ~ est_type, 
    scales = "free",
  ) +
  labs(
    title = 'Proportion of violent to non-violent crime based on establishment type' ,
    x = 'Establishment type' ,
    y = 'Number of offenses' ,
    fill = 'Type of offense'
  )
```
]
.pull-right[
```{r bar-plots-est, echo = FALSE}
data_type_age <- data_type %>%
  select(offence_type, age_group) %>%
  mutate(
    count = n(),
    count = case_when(
      count == 37552 ~ 1
    ),
    count = as.numeric(count)
  )

data_type_age %>%
  ggplot(aes(
    x = age_group, 
    y = count, 
    fill = offence_type)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  facet_wrap(
    ~ age_group, 
    scales = "free",
  ) +
  labs(
    title = 'Proportion of violent to non-violent crime based on age group' ,
    x = 'Age' ,
    y = 'Number of offenses' ,
    fill = 'Type of offense'
  )
```

These graphs show how the proportion of violent to non-violent crime changes based on the independent variables of the dataset. Based on the first graph, sex doesn't seem to be a predictor due to there being no change between male and female offenders. Establishment type and age groups appear to have an effect on the proportion so can be investigated later on in the model as predictors.
]

---

class: middle

.pull-left[
```{r, echo = FALSE}

data <- read_excel("data/Copy of Punishments.xlsx")

#having to set the data into the different age categories

data <- data %>%
  mutate(
    `Age group` = factor(`Age group`, 
                         levels = c("15 - 17", "18 - 20", "21 - 24", "25 - 29",
                                    "30 - 39", "40 - 49", "50 - 59", "60 - 69", "70 and over")),
    `Predominant function of establishment` = factor(`Predominant function of establishment`)
  )

#making the graph having to make it into count plot so the frequency can be determined

ggplot(data,
       aes(
    x = `Age group`,
    y = `Predominant function of establishment`
)) +
    geom_count(color="Green", alpha = 0.7) +
    scale_size_area(max_size = 20) +
    labs(
        title = "Frequency of Establishment Function by Age Group",
        x = "Age group",
        y = "Predominant function of establishment",
        size = "Count"
    ) +
    theme_minimal()+ 
  theme( axis.text.x = element_text(angle = 45, hjust = 1) 
         )

#- Use `---` to separate slides and `--` for incremental builds


#- (describe what each bar plot shows in terms of changing proportion of violent to non-violent crimes, because sex doesnt have any change say why we discount it going forward in the investigation)

```
As you can see in this count plot it is clear that with the exception of youth institutions all the different establishments showed the highest number of inhabitants with individuals aged 30-39. 

]
.pull-right[
```{r, echo = FALSE}
data$`No of days` <- as.numeric(data$`No of days`)

data %>%
  group_by(`Age group`) %>%
  summarise(
    mean_days = mean(`No of days`, na.rm = TRUE),
    median_days = median(`No of days`, na.rm = TRUE),
    total_days = sum(`No of days`, na.rm = TRUE)
  )
```

This table highlights the disparity in the amount of time each age groups are spending in these establishments ]

---

#Exploratory Observations

The prior data visualisations suggest that offence type is influenced by several key variables:

--

- Age, this shows a strong effect, with younger offenders more likely to be involved in certain violent or high-risk offences, while older groups tend to appear more often in less impulsive or lower-severity categories. 

--

- Establishment type, also shows a strong effect with the sites geared towards young offenders being more likely to commit violent crime and the lower-security sites showing a lower rate of violent crime.

--

- Sex, this doesnâ€™t seem to be major predictor, although overall males committed more crimes but the rate of violent versus non-violent is around the same. 

--

Together, these variables indicate that offence type is not random but closely linked to demographic and contextual factors, with age and establishment type showing the strongest influence in the data.


---

#Number of prisoners by age 
.pull-left[ 
```{r,echo=FALSE, results='hide',message=FALSE}

# load your data 
data <- read_excel("data/criminal age dataset.xlsx")

#renaming column heading and cleaning the data so that mini headings are not in the age column
names(data)[1] <- "age"

clean_data <- data %>%
  filter(
    !age %in% c("Males and Females", "Remand", "Sentenced", "Non criminal prisoners")
  )

#removing the percentage change column

clean_data <- clean_data %>%
  select(-`Percentage change \r\nJune 2022 to 2023`)


#having to change the format of the data set to long form

data_long <- clean_data %>%
  pivot_longer(
    cols = -age,
    names_to = "date",
    values_to = "values"
  )

#forcing the value to be numeric 

data_long$values <- as.numeric(gsub(",", "", data_long$values))

#bar plot to compare age against total number of criminals

ggplot(data_long, aes(
    x = age,
    y = values / 1000,
    fill = date
    )) +
  geom_bar(stat="identity") +
  labs(
    x = "age categories",
    y = "number of prisoners in thousands",
    title = "Number of prisoners by age",
    subtitle = "data between 2022 and 2023",
    fill = "date")




```

We first found the number of prisoners per age group and found that the largest number of offenders are within the age range of  30-39. We found that the further away you move on either side of this category - the younger and/or older you get- there are less people in the prison system/ less offenders.]

.pull-right[
```{r, echo=FALSE}
percentage_by_age <- data_long %>%
  group_by(age) %>%
  summarise(total = sum(values, na.rm = TRUE)) %>%
  mutate(percent = total / sum(total) * 100)

percentage_by_age
```
This table highlights the percentage that an age group makes up of the overall prison poulation]
---
#Proportion of sentence lengths by age groups
.pull-left[
```{r, echo=FALSE,warning=FALSE, message=FALSE}
data <- read_excel("data/Age vs Sentence 1.0.xlsx")
names(data)[1] <- "Category"

data <- data %>%
  mutate(across(-Category, as.numeric),
         Total = rowSums(across(-Category), na.rm = TRUE))

age_groups <- c("Adults", "18-20 year olds", "15-17 year olds")

data_summary <- data %>%
  mutate(Age = if_else(Category %in% age_groups, Category, NA_character_)) %>%
  fill(Age) %>%
  filter(Category %in% c(
    "Less than or equal to 6 months",
    "Greater than 6 months to less than 12 months",
    "12 months to less than 4 years",
    "4 years or more (excluding indeterminate sentences)"
  )) %>%
  group_by(Age, Category) %>%
  summarise(Total = sum(Total, na.rm = TRUE)) %>%
  mutate(Proportion = Total / sum(Total))

ggplot(data_summary, aes(x = Age, y = Proportion, fill = Category)) +
  geom_col(position = "fill") +
  scale_y_continuous(labels = percent, breaks = seq(0, 1, 0.1)) +
  labs(
    title = "Proportion of Sentence Lengths by Age Group",
    subtitle = "From 2002-2023",
    x = "Age Group",
    y = "Proportion", 
    fill = "Sentence Length"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))



```

```{r, echo=FALSE}
sentence_category <- data_summary %>%
  group_by(Category) %>%
  summarise(
    total = sum(Total)/1000,
    mean = mean(Total)/1000,
    median = median(Total)/1000,
    sd = sd(Total)/1000
  )

sentence_category
```
]

.pull-right[Shown in this graph is that the younger you are the more lenient the sentence length you get is, this could also show that younger people commit less severe/ harmful crimes compared to older age groups]

---

class: inverse, middle, center

# Modelling and Model Evaluation

---

# Modelling

- Based off of the prior data visualisations, we chose age group and establishment type as the explanatory variables. As our target variable was whether a crime was violent or non-violent, a binary outcome, we chose to use logistic regression as our model choice.

--

- The output of the fitted model is as shown on the next slide. A positive coefficient indicates that the corresponding predictor is associated with a higher likelihood of a crime being violent, the intercept indicates that the overall probability of a crime being violent is < 0.5. The coefficient of the open type establishment was the lowest at -3.27, indicating that it has a significantly higher probability of a crime being non-violent compared to the baseline of the high security establishment. The local type establishment has the highest coefficient of all the predictors at 0.362, showing that it is more likely for a crime to be violent compared to high security.

---
class: middle

```{r model, echo = FALSE}
set.seed(32)
data_split <- initial_split(data_type)
data_train <- training(data_split)
data_test <- testing(data_split)

## ROC curve of all categorical predictors
data_mod <- logistic_reg() %>% 
  set_engine("glm")

data_rec <- recipe(offence_type ~ est_type + age_mod, data = data_train) %>%
  step_dummy(all_nominal(), -all_outcomes())

data_wflow <- workflow() %>%
  add_recipe(data_rec) %>%
  add_model(data_mod)

data_fit <- fit(data_wflow, data_train)

tidy(data_fit) %>%
  kable(format = "html")
```

---

# Model Evaluation

.pull-left[
- To assess the performance of the model, a ROC curve was plotted with both categorical predictors included, the AUC of this curve was calculated to be 0.646. The AUC value shows that the model is moderately effective at identifying if a crime is violent or non-violent.

- The seperate ROC curves for age group and establishment type were also plotted, with the AUC for both of them being 0.615 showing that age group and establishment type are equally strong predictors.
]
.pull-right[
```{r ROC-curve, echo = FALSE}
pred_test <- predict(
  data_fit, data_test, type = "prob"
) %>%
  bind_cols(data_test %>% select(offence_type))

pred_test %>%
  roc_curve(
    truth = offence_type,
    `.pred_Violent`,
    event_level = "second"
  ) %>%
  autoplot()
```
]

---

class: inverse, middle, center

# Conclusion

---

# Limitations and Considerations

- The categories of violent and non-violent crimes where created from a variable listing many different categories of crime. They were sorted into the two categories by having 'violence' become violent crime and all others be non-violent , however, what is categorised as a violent crime can change based on people's different definitions so the model created might not always represent all crimes that could be thought of as violent.

--

- The age group variable has an influence on the establishment type variable due to some of it's categories being age dependent. This might explain why the two ROC curves for each predictor ended up being so similar. 

---
# Conclusion

This project demonstrates that age group and establishment type moderately influences whether a crime an offender commits is violent or non-violent. In future investigations, more variables could be considered to build a better predictor of the offence type of offenders.

---

# References

- Offender Management Statistics Quarterly: January to March 2023. (2023). Ministry of Justice, HM Prison and Probation Service.
https://www.gov.uk/government/statistics/offender-management-statistics-quarterly-january-to-march-2023
